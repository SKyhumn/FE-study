# 4.Authentication

웹 앱에서 **사용자 관리**, **로그인**, **회원가입**, **로그아웃** 같은 기능을 간단히 구현할 수 있도록 도와주는 기능이다.

![image.png](./img/스크린샷XII)

- 로그인할 때 무엇으로 로그인 가능하게 할 건지 여기서 선택할 수 있다.
- 기본 로그인 방식인 이메일/비밀번호 형태 말고도 구글, 페이스북, 트위터 등등 다양한 방법으로 로그인 가능하게 제공할 수 있다.

![image.png](./img/스크린샷XIII)

- 누가 로그인 했는지 확인 및 관리할 수 있다.

## 회원가입/로그인 기능 만들기

### 1.SDK파일

```tsx
import { initializeApp } from "firebase/app";
import { getAuth } from "firebase/auth"; // import 하기

const firebaseConfig = {
  apiKey: "AIzaSyD-bjIutnMyVvgRgtYIdXcu-TrOtkAcCms",
  authDomain: "my-project-6c577.firebaseapp.com",
  projectId: "my-project-6c577",
  storageBucket: "my-project-6c577.firebasestorage.app",
  messagingSenderId: "13649793757",
  appId: "1:13649793757:web:f84eca0f039eb16f934134"
};

const app = initializeApp(firebaseConfig);
export const auth=getAuth(app); // auth객체 만들어주기
```

- `getAuth` 를 import시켜준다.
- `auth` 변수를 만들어주고 `getAuth(app)` 을 대입을 시켜줌으로써 `auth` 객체를 만들어준다.

### getAuth()란?

- **Firebase Auth 객체를 생성**하거나 가져오는 함수이다.
- 즉, **“이 앱에서 사용자 인증 기능을 쓰겠다”**라고 Firebase에 알려주는 역할이다.

### 2.회원가입

```tsx
import './App.css';
import { useState } from 'react';
import { createUserWithEmailAndPassword } from 'firebase/auth';
import { auth } from './firebase/firebase.ts';

function App() {
  const [email, setEmail]=useState<string>("");
  const [password, setPassword]=useState<string>("");
  const [loading, setLoading]=useState<boolean>(false);
  const [error, setError]=useState<null|string>(null);

  const handleSignup=async(e:React.FormEvent)=>{
    e.preventDefault();
    setLoading(true);
    setError(null);

    try{
      await createUserWithEmailAndPassword(auth, email, password);
      alert('회원가입 성공');
      setEmail("");
      setPassword("");
    } catch(err:any){
      setError(err.message);
    } finally{
      setLoading(false);
    }
  }

  return (
    <div className="app">
      {error&&<p>회원가입에 실패했습니다.</p>}
      <form onSubmit={handleSignup}>
        <h2>회원가입</h2>
        <p>이메일</p>
        <input type='email' placeholder='이메일' value={email} onChange={(e)=>setEmail(e.target.value)}></input>
        <p>비밀번호</p>
        <input type='password' placeholder='비밀번호' value={password} onChange={(e)=>setPassword(e.target.value)}></input>
        <button disabled={loading}>{loading?'가입 중...':'가입하기'}</button>
      </form>
    </div>
  )
}

export default App
```

1. `createUserWithEmailAndPassword` 와 sdk파일에서 만든 `auth` 객체를 import한다.
2. 회원가입 결과를 받기 전까지 버튼 모양이 바뀌어야 하므로 `email` , `password` 뿐만 아니라 `loading` state도 만들어준다. 또한 오류가 났을 때를 대비해서 `error` state도 만들어준다.
3. 가입하기 버튼을 누르면 제출이 됨과 동시에 `handleSignup` 함수를 실행해준다.
    1. `e.preventDefault()` 를 사용함으로써 불필요한 새로고침을 막는다.
    2. `loading` state를 **true**로 바꾸고 `error` state를 **null**로 초기화한다.
    3. `createUserWithEmailAndPassword(auth, email, password)` 로 이메일과 비밀번호가 등록되기를 기다린다.
    4. 등록이 성공되면 알림창을 띄우고 `email` state와 `password` state를 초기화한다.
    5. 실패되면 `error` state를 `에러.message` 로 바꾼다.
    6. 마지막에 `loading` state는 초기화된다.

### 3.로그인

```tsx
import './App.css';
import { useState } from 'react';
import { signInWithEmailAndPassword } from 'firebase/auth';
import { auth } from './firebase/firebase.ts';

function App() {
  const [email, setEmail]=useState<string>("");
  const [password, setPassword]=useState<string>("");
  const [loading, setLoading]=useState<boolean>(false);
  const [error, setError]=useState<null|string>(null);

  const handleSignin=async(e:React.FormEvent)=>{
    e.preventDefault();
    setLoading(true);
    setError(null);

    try{
      await signInWithEmailAndPassword(auth, email, password);
      alert('로그인 성공');
      setEmail("");
      setPassword("");
    } catch(err:any){
      setError(err.message);
    } finally{
      setLoading(false);
    }
  }

  return (
    <div className="app">
      {error&&<p>로그인에 실패했습니다.</p>}
      <form onSubmit={handleSignin}>
        <h2>회원가입</h2>
        <p>이메일</p>
        <input type='email' placeholder='이메일' value={email} onChange={(e)=>setEmail(e.target.value)}></input>
        <p>비밀번호</p>
        <input type='password' placeholder='비밀번호' value={password} onChange={(e)=>setPassword(e.target.value)}></input>
        <button disabled={loading}>{loading?'진행 중...':'로그인'}</button>
      </form>
    </div>
  )
}

export default App
```

- `createUserWithEmailAndPassword` 대신에 `signInWithEmailAndPassword`와 sdk파일에서 만든 `auth` 객체를 import한다.
- 버튼과 함수명 모두 목적에 맞게 이름을 변경해준다.
- `signInWithEmailAndPassword` 는 로그인 기능이기에 사용자 리스트에 없는 정보를 입력하면 로그인이 불가능하다.

| `createUserWithEmailAndPassword` | **회원가입** 기능 |
| --- | --- |
| `signInWithEmailAndPassword` | **로그인(이메일/비밀번호)** 기능 |

## OAuth로그인 기능 구현 방법(구글 기준)

OAuth란 자신의 이메일, 비밀번호를 직접 입력하지 않고 구글, 페이스북, 트위터 등 소셜미디어로 로그인을 할 수 있는 기능이다.

### 1.SDK파일

```tsx
import { initializeApp } from "firebase/app";
import { getAuth, GoogleAuthProvider } from "firebase/auth";

const firebaseConfig = {
  apiKey: "AIzaSyD-bjIutnMyVvgRgtYIdXcu-TrOtkAcCms",
  authDomain: "my-project-6c577.firebaseapp.com",
  projectId: "my-project-6c577",
  storageBucket: "my-project-6c577.firebasestorage.app",
  messagingSenderId: "13649793757",
  appId: "1:13649793757:web:f84eca0f039eb16f934134"
};

const app = initializeApp(firebaseConfig);
export const auth=getAuth(app);
export const googleProvider=new GoogleAuthProvider();
```

- 제공하려고 하는 제공업체대로 AuthProvider를 import한다.
- Provider 변수를 생성하고 생성자를 호출한다.

| **SNS** | **Provider객체** |
| --- | --- |
| 구글 | `GoogleAuthProvider` |
| 페이스북 | `FacebookAuthProvider` |
| 트위터 | `TwitterAuthProvider` |
| 깃허브 | `GithubAuthProvider` |

### 2.App.tsx

```tsx
import { signInWithPopup } from 'firebase/auth';
import { auth, googleProvider } from './firebase/firebase.ts';
```

- `signInWithPopup` 과 sdk파일에서 만든 Provider객체를 import한다.

```tsx
<button onClick={signInWithGoogle}>Sign in with Google</button>
```

- 구글로 로그인하는 버튼을 만들어준다.
- 구글로 로그인 할 수 있는 함수를 만들어준다.

```tsx
const signInWithGoogle=async()=>{
  setError(null);
  setLoading(true);
  try{
    const res=await signInWithPopup(auth, googleProvider);
    alert(`${res.user.displayName}님 로그인 성공`);
  } catch(err:any){
    setError(err.message);
  } finally{
    setLoading(false);
  }
}
```

1. `signInWithPopup(auth, googleProvider)` 로 구글로 로그인이 완료되기를 기다린다.
2. 로그인이 성공하면 유저 객체를 `res` 에 받아들이고 알림창을 띄운다.
3. 로그인이 실패하면 `error` state를 `에러.message` 로 바꾼다.
4. 마지막엔 `loading` state를 false로 바꾼다.

### `signInWithRedirect` 로 구글로그인 기능 만들기

- `signInWithRedirect` 란 팝업 대신 **페이지 전체 이동** 방식으로 로그인하는 방식이다.
- `signInWithPopup` 대신 `signInWithRedirect` 를 import 해주는 방법이 있다.

## 인증 후 토큰 받기

Firebase Authentication은 로그인 성공 시 **Firebase User객체**를 반환하고 이 객체로부터 **JWT형식의 ID 토큰** 을 가져올 수 있다.

### 이메일/비밀번호 로그인하고 ID토큰 받기

```tsx
  /*
  const handleSignin=async(e:React.FormEvent)=>{
    e.preventDefault();
    setLoading(true);
    setError(null);

    try{*/
      const userCredential=await signInWithEmailAndPassword(auth, email, password);
      const user=userCredential.user;
      const token=await user.getIdToken();
      console.log("토큰:"+token);
      /*
      alert('로그인 성공');
      setEmail("");
      setPassword("");
    } catch(err:any){
      console.log(err.code);
    } finally{
      setLoading(false);
    }
  }
```

- 만든 변수 `userCredential` 에 로그인 후 사용자 객체를 받아들인다.
- `userCredential` 객체에서 `user` 속성을 따와 변수 `user` 에 대입한다.
- `getIdToken()` 을 이용하여 토큰을 추출한다.

### 구글로 로그인하고 ID토큰 받기

- 구글 로그인은 추가로 **Google OAuth Access Token**(구글 API용)도 같이 받을 수 있다.
- ID토큰을 가져오는 방법은 똑같다.

### 액세스 토큰 가져오기

```tsx
const credential=GoogleAuthProvider.credentialFromResult(로그인 후 받아온 user객체);
const accessToken=credential?.accessToken;
console.log("Google Access Token:",accessToken);
```

- `GoogleAuthProvider.credentialFromResult()` 는 **구글 로그인 결과(UserCredential)에서 구글 OAuth 정보를 꺼내는 함수**이다.
- `signInWithPopup()` 또는 `signInWithRedirect` 로 로그인한 후 `UserCredential` 안에 있는 **구글 제공자 관련 정보**를 추출할 때 사용한다.
- `credential` 에서 `.accessToken`을 이용해 액세스 토큰을 추출해서 `accessToken` 변수에 넣는다.
- 액세스 토큰은 **구글 프로필 정보 가져오기, 여러 구글 프로그램 API로 접근하기** 기능을 도와준다.

### ID토큰을 localStorage에 저장하기

```tsx
localStorage.setItem("firebaseToken", token);
```

- `localStorage.setItem("firebaseToken", 토큰 변수 이름)` 으로 토큰을 저장한다.

## 로그아웃 기능 만들기

```tsx
import { signOut } from "firebase/auth";
import { auth } from "./firebase/firebase";

const handleLogout = async () => {
  try {
    await signOut(auth);
    alert("로그아웃 성공!");
  } catch (err) {
    console.error("로그아웃 실패:", err);
  }
};
```

- `signOut` 을 import한다.
- signOut이 완료 되기 전까지 로딩 속성을 true로 해준다.

### ID토큰을 지우기

```tsx
localStorage.remove("firebaseToken");
```

## 로그인 후 반환되는 사용자 객체

```tsx
{
  user: {            // 로그인한 사용자 정보
    uid: "abc123xyz",             // 고유 사용자 ID
    email: "test@example.com",    // 이메일
    displayName: null,            // 이름 (Google 로그인 등일 때 표시됨)
    photoURL: null,               // 프로필 사진 URL (있으면)
    emailVerified: false,         // 이메일 인증 여부
    phoneNumber: null,            // 전화번호 로그인일 경우
    providerData: [...],          // 제공자 정보 (Google, GitHub 등)
    metadata: {
      creationTime: "Thu, 06 Nov 2025 11:10:00 GMT",
      lastSignInTime: "Thu, 06 Nov 2025 11:20:00 GMT"
    },
    accessToken: "..."            // 인증 토큰(내부적으로 사용)
  },
  providerId: null,               // 로그인 제공자 ID
  operationType: "signIn"         // "signIn" 또는 "signUp"
}

```

## Authentication 오류

### 오류 데이터 형식

```tsx
{
  code: string;      // 오류 코드 (항상 "auth/"로 시작)
  message: string;   // 사람이 읽을 수 있는 메시지
  name: string;      // "FirebaseError"
  customData?: any;  // (일부 로그인 제공자에서만 있음)
}
```

```tsx
{
  "code": "auth/wrong-password",
  "message": "Firebase: Error (auth/wrong-password).",
  "name": "FirebaseError"
}
```

### 이메일/비밀번호 오류 코드 종류

| **코드** | **의미** |
| --- | --- |
| `auth/invalid-email` | 이메일 형식이 잘못 |
| `auth/user-not-found` | 해당 이메일 계정이 없음 |
| `auth/wrong-password` | 비밀번호 틀림 |
| `auth/email-already-in-use` | 이미 가입된 이메일 |
| `auth/weak-password` | 비밀번호가 너무 약함(회원가입시) |
| `auth/missing-password` | 비밀번호 입력 안 됨 |
| `auth/too-many-requests` | 여러 번 로그인 실패 Firebase에서 일시 차단 |
| `auth/network-request-failed` | 네트워크 오류 |

### OAuth 관련 오류 코드 종류

| **코드** | **의미** |
| --- | --- |
| `auth/popup-closed-by-user` | 사용자가 팝업을 닫음 |
| `auth/cancelled-popup-request` | 여러 팝업이 동시에 열림 |
| `auth/popup-blocked` | 브라우저가 팝업 차단 |
| `auth/account-exists-with-different-credential` | 동일 이메일이 다른 제공자에 연결됨 |
| `auth/unauthorized-domain` | Firebase 콘솔에 등록되지 않은 도메인 |
| `auth/network-request-failed` | 네트워크 오류 |
| `auth/internal-error` | Firebase 내부 오류 |
