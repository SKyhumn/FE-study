# 5.Firestore DB

Firestore DB는 **Google Firebase**에서 제공하는 **클라우드 기반 NoSQL 데이터베이스**이다.

## 주요 특징

- **실시간 동기화**
    - 여러 기기나 클라이언트가 데이터를 동시에 수정해도 자동으로 업데이트 됨
- **클라우드 기반**
    - 서버 따로 안 만들어도 Firebase가 서버를 대신 관리함
- **크로스 플랫폼 지원**
    - Web, android, ios, node js 등에서 사용 가능
- **자동 확장성**
    - 트래픽이 늘어나도 서버를 직접 늘릴 필요 없음
- **보안 규칙**
    - 누가 어떤 데이터에 접근할 수 있는지 세밀하게 제어 가능

## Firestore DB구조

- **컬렉션(collection)**
    - 최상위 데이터 모음집(폴더 역할)
- **문서(document)**
    - 데이터 문서들
- **필드(field)**
    - 문서를 이루고 있는 데이터들

## DB만들기

### 1.컬렉션 만들기

![image.png](./img/스크린샷XIV)

**컬렉션 시작**을 클릭하고 **컬렉션 ID**를 작성한다.

### 2.문서와 필드 만들기

![image.png](./img/스크린샷XV)

**문서ID**를 작성하고 필드의 이름과 유형을 정한 뒤 값을 입력한다.

![image.png](./img/스크린샷XVI)

- 이 데이터에서 문서나 필드를 더 추가할 수 있다.

## 데이터 가져오는 법

### 1.SDK파일

```tsx
// Import the functions you need from the SDKs you need
import { initializeApp } from "firebase/app";
import { getFirestore } from "firebase/firestore";
// TODO: Add SDKs for Firebase products that you want to use
// https://firebase.google.com/docs/web/setup#available-libraries

// Your web app's Firebase configuration
const firebaseConfig = {
  apiKey: "AIzaSyCSVFeL873tKSS7TItsatrr8245vf_R0O0",
  authDomain: "my-project-9227f.firebaseapp.com",
  projectId: "my-project-9227f",
  storageBucket: "my-project-9227f.firebasestorage.app",
  messagingSenderId: "726951176637",
  appId: "1:726951176637:web:2dfaa9f29e3ba7a6c98ad4"
};

// Initialize Firebase
const app = initializeApp(firebaseConfig);
export const db=getFirestore(app);
```

- `getFireStore` 을 import한다.
- `db` 변수를 만들고 `getFireStore(app)` 을 대입한 뒤 export한다.

### 2.데이터 불러오기

먼저 규칙 탭으로 가서 코드를 수정한다.

![image.png](./img/스크린샷XVII)

**수정 전**

```tsx
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if false;
    }
  }
}
```

**수정 후**

```tsx
rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {
    match /{document=**} {
      allow read, write: if true;
    }
  }
}
```

개발 테스트용 설정이므로 실제로 배포 시 절대 이렇게 두면 안된다.

### 단일 데이터 불러오기

```
import { doc, getDoc } from 'firebase/firestore';
import { db } from './firebase/firebase';
```

- `doc` 와 `getDoc` , `db` 를 import 한다.

```tsx
const getUser=async()=>{
  const docSnap=await getDoc(doc(db,"컬렉션 이름","문서 이름"));

  // 코드 
}
```

- `getDoc()` 함수에다 `doc(db,"컬렉션 이름","문서 이름")` 을 대입한다.
- ex) 컬렉션 이름 **‘my-project’**, 문서 이름 **‘회원정보1’**: `doc(db, "my-project", "회원정보1")`
- `doc()` 함수는 컬렉션 안의 문서의 주소를 불러온다.
- `getDoc()` 함수는 스냅샷을 불러올 수 있다.
- 불러온 정보는 객체 형식으로 불러 와지며 필드 값들은 `docSnap.data()` 로 추출할 수 있다.

### 컬렉션 전체 불러오기

```tsx
import { collection, getDocs } from 'firebase/firestore';
import { db } from './firebase/firebase';
```

- `doc` 과 `getDoc` 대신에 `collection` 과 `getDocs` 를 import한다.

```tsx
const getAllUsers=async()=>{
  const querySnapShots=await getDocs(collection(db, "my-project"));
  querySnapShots.docs.forEach((doc)=>{
    console.log(doc.data());
  })
}
```

- `querySnapShots` 변수를 만들고 `getDocs()` 함수에 `collection(db, "컬렉션 이름")` 을 대입해서 스냅샷을 불러올 수 있다.
- `collection()` 함수로 DB의 모든 컬렉션들을 불러올 수 있다.

**querySnapShots의 구조**

```tsx
QuerySnapshot {
  docs: [ QueryDocumentSnapshot, QueryDocumentSnapshot, ... ],
  size: 3,
  empty: false
}
```

- `querySnapShots.docs.forEach` 구문은 `querySnapShots` 객체에서 `doc` 배열에서 원소들을 순서대로 콘솔에 출력하는 것이다.

### 조건으로 데이터 불러오기

```tsx
import { collection, getDocs, query, where } from 'firebase/firestore';
import { db } from './firebase/firebase';
```

- `where` 와 `query` 를 추가로 더 import 해준다.

```tsx
const getAllUsers=async()=>{
  const querySnapShots=await getDocs(query(collection(db, "my-project"),where("나이",">=",17)));
  querySnapShots.docs.forEach((doc)=>{
    console.log(doc.data());
  })
}
```

- `query()` 는 `where()` 조건에 따라서 문서들을 불러온다.
- `where()` 로 조건을 정해준다.
- `where("필드 이름", "비교 연산자", 비교값)` 형식으로 조건을 정해준다.
- `getDocs()` 함수로 스냅샷을 가져온다.

### `getDoc` VS `getDocs`

- `getDoc`
    - `doc(db, "컬렉션명", "문서ID")` 함수로 하나의 문서 스냅샷만 불러올 수 있다.
- `getDocs`
    - `collection(db, "컬렉션명")` 혹은 `query()` 함수로 여러 문서들의 스냅샷을 불러올 수 있다.

## 데이터 추가하기

```tsx
import { collection, addDoc } from 'firebase/firestore';
```

`addDoc` , `collection`을 import한다.

```tsx
const addData=async()=>{
  try{
    await addDoc(collection(db, "my-project"),{
      나이:22,
      createdAt:new Date()
    });
    console.log("문서가 추가되었습니다.");
  } catch(e){
    console.log("문서 추가 중 오류 발생:",e);
  } 
}
```

- `addDoc()` 함수 안에 `collection(db, "컬렉션 이름")` 을 넣는다
- `collection()` 뒤에는 객체 형식으로 데이터를 적다.

## 데이터 수정하기

### 기존 문서의 일부 필드만 수정하기

```tsx
import { doc, updateDoc } from 'firebase/firestore';
import { db } from './firebase/firebase';
```

`doc` 과 `updateDoc` 을 import한다.

```tsx
const updateData=async()=>{
  try{
    await updateDoc(doc(db, "my-project", "회원정보1"),{
      나이:20
    });
    console.log("수정 성공");
  } catch(e){
    console.log("수정 실패:",e);
  }
}
```

- `updateDoc()` 함수 안에 `doc(db, "컬렉션 이름", "문서 이름")` 을 넣는다.
- 데이터는 객체 형식으로 적는다.

### 문서 전체 덮어쓰기

```tsx
import { doc, setDoc } from 'firebase/firestore';
import { db } from './firebase/firebase';
```

`doc` 와 `setDoc` 을 import한다.

```tsx
const modifyData=async()=>{
  try{
    await setDoc(doc(db,"my-project","회원정보2"),{
      나이:21,
      국적:"미국",
      취미:"요가"
    })
    console.log("수정 성공")
  } catch(e){
    console.log("수정 실패:",e)
  }
}
```

- `setDoc()` 함수 안에 `doc(db, "컬렉션 이름", "문서 이름")` 을 넣는다.
- 데이터는 객체 형식으로 적는다.

###
